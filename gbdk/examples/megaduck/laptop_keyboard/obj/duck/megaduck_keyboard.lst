                                      1 ;--------------------------------------------------------
                                      2 ; File Created by SDCC : free open source ISO C Compiler
                                      3 ; Version 4.5.1 #15267 (Mac OS X ppc)
                                      4 ;--------------------------------------------------------
                                      5 	.module megaduck_keyboard
                                      6 	
                                      7 ;--------------------------------------------------------
                                      8 ; Public variables in this module
                                      9 ;--------------------------------------------------------
                                     10 	.globl _duck_io_scancode_to_ascii
                                     11 	.globl _duck_io_send_cmd_and_receive_buffer
                                     12 	.globl _key_previous
                                     13 	.globl _key_repeat_previous
                                     14 	.globl _key_pressed
                                     15 	.globl _key_repeat_timeout
                                     16 	.globl _key_repeat_allowed
                                     17 	.globl _duck_io_poll_keyboard
                                     18 	.globl _duck_io_process_key_data
                                     19 ;--------------------------------------------------------
                                     20 ; special function registers
                                     21 ;--------------------------------------------------------
                                     22 ;--------------------------------------------------------
                                     23 ; ram data
                                     24 ;--------------------------------------------------------
                                     25 	.area _DATA
                                     26 ;--------------------------------------------------------
                                     27 ; ram data
                                     28 ;--------------------------------------------------------
                                     29 	.area _INITIALIZED
    00000000                         30 _key_repeat_allowed::
    00000000                         31 	.ds 1
    00000001                         32 _key_repeat_timeout::
    00000001                         33 	.ds 1
    00000002                         34 _key_pressed::
    00000002                         35 	.ds 1
    00000003                         36 _key_repeat_previous::
    00000003                         37 	.ds 1
    00000004                         38 _key_previous::
    00000004                         39 	.ds 1
                                     40 ;--------------------------------------------------------
                                     41 ; absolute external ram data
                                     42 ;--------------------------------------------------------
                                     43 	.area _DABS (ABS)
                                     44 ;--------------------------------------------------------
                                     45 ; global & static initialisations
                                     46 ;--------------------------------------------------------
                                     47 	.area _HOME
                                     48 	.area _GSINIT
                                     49 	.area _GSFINAL
                                     50 	.area _GSINIT
                                     51 ;--------------------------------------------------------
                                     52 ; Home
                                     53 ;--------------------------------------------------------
                                     54 	.area _HOME
                                     55 	.area _HOME
                                     56 ;--------------------------------------------------------
                                     57 ; code
                                     58 ;--------------------------------------------------------
                                     59 	.area _CODE
                                     60 ;src/megaduck_keyboard.c:43: bool duck_io_poll_keyboard(duck_keyboard_data_t * key_data) {
                                     61 ;	---------------------------------
                                     62 ; Function duck_io_poll_keyboard
                                     63 ; ---------------------------------
    00000000                         64 _duck_io_poll_keyboard::
    00000000 3B               [ 8]   65 	dec	sp
    00000001 3B               [ 8]   66 	dec	sp
                                     67 ;src/megaduck_keyboard.c:45: if (duck_io_send_cmd_and_receive_buffer(DUCK_IO_CMD_GET_KEYS)) {
    00000002 D5               [16]   68 	push	de
    00000003 AF               [ 4]   69 	xor	a, a
    00000004 CDr00r00         [24]   70 	call	_duck_io_send_cmd_and_receive_buffer
    00000007 5F               [ 4]   71 	ld	e, a
    00000008 C1               [12]   72 	pop	bc
    00000009 CB 43            [ 8]   73 	bit	0, e
    0000000B 28 19            [12]   74 	jr	Z, 00104$
                                     75 ;src/megaduck_keyboard.c:46: if (duck_io_rx_buf_len == DUCK_IO_LEN_KBD_GET) {
    0000000D FAr00r00         [16]   76 	ld	a, (#_duck_io_rx_buf_len)
    00000010 D6 02            [ 8]   77 	sub	a, #0x02
    00000012 20 12            [12]   78 	jr	NZ, 00104$
                                     79 ;src/megaduck_keyboard.c:47: key_data->flags     = duck_io_rx_buf[DUCK_IO_KBD_FLAGS];
    00000014 33               [ 8]   80 	inc	sp
    00000015 33               [ 8]   81 	inc	sp
    00000016 C5               [16]   82 	push	bc
    00000017 FAr00r00         [16]   83 	ld	a, (#_duck_io_rx_buf + 0)
    0000001A E1               [12]   84 	pop	hl
    0000001B E5               [16]   85 	push	hl
    0000001C 77               [ 8]   86 	ld	(hl), a
                                     87 ;src/megaduck_keyboard.c:48: key_data->scancode  = duck_io_rx_buf[DUCK_IO_KBD_KEYCODE];
    0000001D 03               [ 8]   88 	inc	bc
    0000001E FAr01r00         [16]   89 	ld	a, (#(_duck_io_rx_buf + 1) + 0)
    00000021 02               [ 8]   90 	ld	(bc), a
                                     91 ;src/megaduck_keyboard.c:49: return true;
    00000022 3E 01            [ 8]   92 	ld	a, #0x01
    00000024 18 01            [12]   93 	jr	00105$
    00000026                         94 00104$:
                                     95 ;src/megaduck_keyboard.c:52: return false;
    00000026 AF               [ 4]   96 	xor	a, a
    00000027                         97 00105$:
                                     98 ;src/megaduck_keyboard.c:53: }
    00000027 33               [ 8]   99 	inc	sp
    00000028 33               [ 8]  100 	inc	sp
    00000029 C9               [16]  101 	ret
                                    102 ;src/megaduck_keyboard.c:60: char duck_io_process_key_data(duck_keyboard_data_t * key_data, uint8_t megaduck_model) {
                                    103 ;	---------------------------------
                                    104 ; Function duck_io_process_key_data
                                    105 ; ---------------------------------
    0000002A                        106 _duck_io_process_key_data::
    0000002A E8 FC            [16]  107 	add	sp, #-4
    0000002C F8 01            [12]  108 	ldhl	sp,	#1
    0000002E 73               [ 8]  109 	ld	(hl), e
    0000002F 23               [ 8]  110 	inc	hl
    00000030 72               [ 8]  111 	ld	(hl), d
    00000031 5F               [ 4]  112 	ld	e, a
                                    113 ;src/megaduck_keyboard.c:62: key_previous = key_pressed;
    00000032 FAr02r00         [16]  114 	ld	a, (#_key_pressed)
    00000035 EAr04r00         [16]  115 	ld	(#_key_previous),a
                                    116 ;src/megaduck_keyboard.c:70: if ((key_data->flags & DUCK_IO_KEY_FLAG_KEY_REPEAT) && (key_repeat_allowed)) {
    00000038 F8 01            [12]  117 	ldhl	sp,	#1
    0000003A 2A               [ 8]  118 	ld	a, (hl+)
    0000003B 4F               [ 4]  119 	ld	c, a
    0000003C 3A               [ 8]  120 	ld	a, (hl-)
    0000003D 2B               [ 8]  121 	dec	hl
    0000003E 47               [ 4]  122 	ld	b, a
    0000003F 0A               [ 8]  123 	ld	a, (bc)
    00000040 77               [ 8]  124 	ld	(hl), a
    00000041 E5               [16]  125 	push	hl
    00000042 CB 46            [12]  126 	bit	0, (hl)
    00000044 E1               [12]  127 	pop	hl
    00000045 28 22            [12]  128 	jr	Z, 00119$
    00000047 21r00r00         [12]  129 	ld	hl, #_key_repeat_allowed
    0000004A CB 46            [12]  130 	bit	0, (hl)
    0000004C 28 1B            [12]  131 	jr	Z, 00119$
                                    132 ;src/megaduck_keyboard.c:73: key_pressed = NO_KEY;
    0000004E AF               [ 4]  133 	xor	a, a
    0000004F EAr02r00         [16]  134 	ld	(#_key_pressed),a
                                    135 ;src/megaduck_keyboard.c:75: if (key_repeat_timeout) {
    00000052 21r01r00         [12]  136 	ld	hl, #_key_repeat_timeout
    00000055 7E               [ 8]  137 	ld	a, (hl)
    00000056 B7               [ 4]  138 	or	a, a
    00000057 28 03            [12]  139 	jr	Z, 00102$
                                    140 ;src/megaduck_keyboard.c:76: key_repeat_timeout--;
    00000059 35               [12]  141 	dec	(hl)
    0000005A 18 7A            [12]  142 	jr	00120$
    0000005C                        143 00102$:
                                    144 ;src/megaduck_keyboard.c:80: key_pressed = key_repeat_previous;
    0000005C FAr03r00         [16]  145 	ld	a, (#_key_repeat_previous)
    0000005F EAr02r00         [16]  146 	ld	(#_key_pressed),a
                                    147 ;src/megaduck_keyboard.c:81: key_repeat_timeout = REPEAT_CONTINUE_THRESHOLD;
    00000062 21r01r00         [12]  148 	ld	hl, #_key_repeat_timeout
    00000065 36 04            [12]  149 	ld	(hl), #0x04
    00000067 18 6D            [12]  150 	jr	00120$
    00000069                        151 00119$:
                                    152 ;src/megaduck_keyboard.c:85: key_data->flags = key_data->flags;
    00000069 F8 00            [12]  153 	ldhl	sp,	#0
                                    154 ;src/megaduck_keyboard.c:86: uint8_t temp_key_scancode = key_data->scancode;
    0000006B 2A               [ 8]  155 	ld	a, (hl+)
    0000006C 02               [ 8]  156 	ld	(bc), a
    0000006D 2A               [ 8]  157 	ld	a, (hl+)
    0000006E 66               [ 8]  158 	ld	h, (hl)
    0000006F 6F               [ 4]  159 	ld	l, a
    00000070 23               [ 8]  160 	inc	hl
    00000071 7E               [ 8]  161 	ld	a, (hl)
    00000072 F8 03            [12]  162 	ldhl	sp,	#3
    00000074 77               [ 8]  163 	ld	(hl), a
                                    164 ;src/megaduck_keyboard.c:89: if ((key_data->flags & (DUCK_IO_KEY_FLAG_CAPSLOCK | DUCK_IO_KEY_FLAG_SHIFT)) == DUCK_IO_KEY_FLAG_SHIFT)
    00000075 F8 00            [12]  165 	ldhl	sp,	#0
    00000077 7E               [ 8]  166 	ld	a, (hl)
    00000078 E6 06            [ 8]  167 	and	a, #0x06
    0000007A D6 04            [ 8]  168 	sub	a, #0x04
    0000007C 20 06            [12]  169 	jr	NZ, 00105$
                                    170 ;src/megaduck_keyboard.c:90: temp_key_scancode -= DUCK_IO_KEY_BASE;
    0000007E F8 03            [12]  171 	ldhl	sp,	#3
    00000080 7E               [ 8]  172 	ld	a, (hl)
    00000081 C6 80            [ 8]  173 	add	a, #0x80
    00000083 77               [ 8]  174 	ld	(hl), a
    00000084                        175 00105$:
                                    176 ;src/megaduck_keyboard.c:92: key_pressed = duck_io_scancode_to_ascii(temp_key_scancode, megaduck_model);
    00000084 C5               [16]  177 	push	bc
    00000085 F8 05            [12]  178 	ldhl	sp,	#5
    00000087 7E               [ 8]  179 	ld	a, (hl)
    00000088 CDr00r00         [24]  180 	call	_duck_io_scancode_to_ascii
    0000008B C1               [12]  181 	pop	bc
    0000008C 21r02r00         [12]  182 	ld	hl, #_key_pressed
    0000008F 77               [ 8]  183 	ld	(hl), a
                                    184 ;src/megaduck_keyboard.c:95: if ((key_data->flags & (DUCK_IO_KEY_FLAG_CAPSLOCK | DUCK_IO_KEY_FLAG_SHIFT)) == DUCK_IO_KEY_FLAG_CAPSLOCK)
    00000090 0A               [ 8]  185 	ld	a, (bc)
    00000091 E6 06            [ 8]  186 	and	a, #0x06
    00000093 D6 02            [ 8]  187 	sub	a, #0x02
    00000095 20 0E            [12]  188 	jr	NZ, 00110$
                                    189 ;src/megaduck_keyboard.c:96: if ((key_pressed >= 'a') && (key_pressed <= 'z'))
    00000097 7E               [ 8]  190 	ld	a, (hl)
    00000098 D6 61            [ 8]  191 	sub	a, #0x61
    0000009A 38 09            [12]  192 	jr	C, 00110$
    0000009C 3E 7A            [ 8]  193 	ld	a, #0x7a
    0000009E 96               [ 8]  194 	sub	a, (hl)
    0000009F 38 04            [12]  195 	jr	C, 00110$
                                    196 ;src/megaduck_keyboard.c:97: key_pressed -= ('a' - 'A');
    000000A1 7E               [ 8]  197 	ld	a, (hl)
    000000A2 C6 E0            [ 8]  198 	add	a, #0xe0
    000000A4 77               [ 8]  199 	ld	(hl), a
    000000A5                        200 00110$:
                                    201 ;src/megaduck_keyboard.c:101: if (key_data->flags & DUCK_IO_KEY_FLAG_PRINTSCREEN_LEFT)
    000000A5 0A               [ 8]  202 	ld	a, (bc)
    000000A6 CB 5F            [ 8]  203 	bit	3, a
    000000A8 28 05            [12]  204 	jr	Z, 00112$
                                    205 ;src/megaduck_keyboard.c:102: key_pressed = KEY_PRINTSCREEN;
    000000AA 21r02r00         [12]  206 	ld	hl, #_key_pressed
    000000AD 36 06            [12]  207 	ld	(hl), #0x06
    000000AF                        208 00112$:
                                    209 ;src/megaduck_keyboard.c:107: if ((key_pressed >= ' ') ||
    000000AF 21r02r00         [12]  210 	ld	hl, #_key_pressed
                                    211 ;src/megaduck_keyboard.c:108: ((key_pressed >= KEY_ARROW_UP) && (key_pressed <= KEY_ARROW_LEFT))) {
    000000B2 7E               [ 8]  212 	ld	a,(hl)
    000000B3 FE 20            [ 8]  213 	cp	a,#0x20
    000000B5 30 09            [12]  214 	jr	NC, 00113$
    000000B7 D6 01            [ 8]  215 	sub	a, #0x01
    000000B9 38 11            [12]  216 	jr	C, 00114$
    000000BB 3E 04            [ 8]  217 	ld	a, #0x04
    000000BD 96               [ 8]  218 	sub	a, (hl)
    000000BE 38 0C            [12]  219 	jr	C, 00114$
    000000C0                        220 00113$:
                                    221 ;src/megaduck_keyboard.c:109: key_repeat_allowed = true;
    000000C0 21r00r00         [12]  222 	ld	hl, #_key_repeat_allowed
    000000C3 36 01            [12]  223 	ld	(hl), #0x01
                                    224 ;src/megaduck_keyboard.c:110: key_repeat_timeout = REPEAT_FIRST_THRESHOLD;
    000000C5 21r01r00         [12]  225 	ld	hl, #_key_repeat_timeout
    000000C8 36 08            [12]  226 	ld	(hl), #0x08
    000000CA 18 04            [12]  227 	jr	00115$
    000000CC                        228 00114$:
                                    229 ;src/megaduck_keyboard.c:112: key_repeat_allowed = false;
    000000CC AF               [ 4]  230 	xor	a, a
    000000CD EAr00r00         [16]  231 	ld	(#_key_repeat_allowed),a
    000000D0                        232 00115$:
                                    233 ;src/megaduck_keyboard.c:115: key_repeat_previous = key_pressed;
    000000D0 FAr02r00         [16]  234 	ld	a, (#_key_pressed)
    000000D3 EAr03r00         [16]  235 	ld	(#_key_repeat_previous),a
    000000D6                        236 00120$:
                                    237 ;src/megaduck_keyboard.c:118: return key_pressed;
    000000D6 FAr02r00         [16]  238 	ld	a, (_key_pressed)
                                    239 ;src/megaduck_keyboard.c:119: }
    000000D9 E8 04            [16]  240 	add	sp, #4
    000000DB C9               [16]  241 	ret
                                    242 	.area _CODE
                                    243 	.area _INITIALIZER
    00000000                        244 __xinit__key_repeat_allowed:
    00000000 00                     245 	.db #0x00	;  0
    00000001                        246 __xinit__key_repeat_timeout:
    00000001 00                     247 	.db #0x00	; 0
    00000002                        248 __xinit__key_pressed:
    00000002 00                     249 	.db #0x00	; 0
    00000003                        250 __xinit__key_repeat_previous:
    00000003 00                     251 	.db #0x00	; 0
    00000004                        252 __xinit__key_previous:
    00000004 00                     253 	.db #0x00	; 0
                                    254 	.area _CABS (ABS)
